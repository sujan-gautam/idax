// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Plan {
  FREE
  PRO
  ENTERPRISE
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum UploadStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  WAITING_APPROVAL
}

enum JobType {
  PARSE
  EDA
  RECIPE_GEN
  TRANSFORM
}

model Tenant {
  id        String       @id @default(uuid())
  name      String
  plan      Plan         @default(FREE)
  status    TenantStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  users     User[]
  projects  Project[]
  quotas    Quotas?
  featureFlags FeatureFlags?
  apiKeys   ApiKey[]
  auditLogs AuditLog[]
  uploads   Upload[]
  jobs      Job[]
  datasets  Dataset[]
  recipes   Recipe[]
  edaResults EDAResult[]
  subscription   Subscription?
  aiUsage        AiUsage?
  openaiApiKey   String?
  aiChatSessions AiChatSession[]
}

model User {
  id           String     @id @default(uuid())
  email        String     @unique
  name         String?
  passwordHash String?
  role         Role       @default(MEMBER)
  status       UserStatus @default(ACTIVE)
  tenantId     String
  tenant       Tenant     @relation(fields: [tenantId], references: [id])
  createdAt    DateTime   @default(now())
  lastLoginAt  DateTime?
  auditLogs    AuditLog[]
  verificationToken String?
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())
  datasets    Dataset[]
  aiChatSessions AiChatSession[]
}

model Quotas {
  id                 String @id @default(uuid())
  tenantId           String @unique
  tenant             Tenant @relation(fields: [tenantId], references: [id])
  maxProjects        Int    @default(5)
  maxStorageBytes    BigInt @default(1073741824)
  maxUploadsPerMonth Int    @default(50)
  maxApiCallsPerMonth Int   @default(1000)
  maxAiTokensPerMonth Int    @default(50000)
}

model AiUsage {
  id              String   @id @default(uuid())
  tenantId        String   @unique
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  tokensUsed      Int      @default(0)
  promptTokens    Int      @default(0)
  completionTokens Int     @default(0)
  lastUsedAt      DateTime @default(now())
  resetAt         DateTime @default(now())
  totalRequests   Int      @default(0)
}

model FeatureFlags {
  id        String   @id @default(uuid())
  tenantId  String   @unique
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  flagsJson Json     @default("{}")
  updatedAt DateTime @updatedAt
}

model Dataset {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  name        String
  sourceType  String
  activeVersionId String?
  createdAt   DateTime @default(now())
  
  versions    DatasetVersion[]
  uploads     Upload[]
  jobs        Job[]
  recipes     Recipe[]
  aiChatSessions AiChatSession[]
}

model DatasetVersion {
  id             String   @id @default(uuid())
  datasetId      String
  dataset        Dataset  @relation(fields: [datasetId], references: [id])
  versionNumber  Int
  parentVersionId String?
  artifactS3Key  String
  schemaJson     Json?
  statsSummaryJson Json?
  sourceType     String?
  sourceId       String?
  rowCount       Int?
  columnCount    Int?
  createdAt      DateTime @default(now())
  createdBy      String?

  jobs           Job[]
  edaResults     EDAResult[]
}

model Upload {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  datasetId   String?
  dataset     Dataset? @relation(fields: [datasetId], references: [id])
  filename    String
  contentType String
  s3Key       String
  status      UploadStatus @default(PENDING)
  createdAt   DateTime @default(now())
}

model Job {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  datasetId       String?
  dataset         Dataset? @relation(fields: [datasetId], references: [id])
  datasetVersionId String?
  datasetVersion  DatasetVersion? @relation(fields: [datasetVersionId], references: [id])
  type            JobType
  status          JobStatus @default(PENDING)
  progress        Int       @default(0)
  startedAt       DateTime?
  finishedAt      DateTime?
  errorJson       Json?
  correlationId   String?
}

model EDAResult {
  id               String   @id @default(uuid())
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id])
  datasetVersionId String
  datasetVersion   DatasetVersion @relation(fields: [datasetVersionId], references: [id])
  resultS3Key      String?
  summaryJson      Json?
  status           String   @default("pending")
  results          Json?
  errorMessage     String?
  createdAt        DateTime @default(now())
}

model AiChatSession {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  datasetId String?
  dataset   Dataset? @relation(fields: [datasetId], references: [id])
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])
  title     String?
  messages  AiChatMessage[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([datasetId])
}

model AiChatMessage {
  id        String   @id @default(uuid())
  sessionId String
  session   AiChatSession @relation(fields: [sessionId], references: [id])
  role      String   // 'user' or 'assistant'
  content   String
  provider  String?  // 'gemini' or 'openai'
  tokens    Int?
  createdAt DateTime @default(now())

  @@index([sessionId])
}

model Recipe {
  id                 String   @id @default(uuid())
  datasetId          String
  dataset            Dataset  @relation(fields: [datasetId], references: [id])
  tenantId           String
  tenant             Tenant   @relation(fields: [tenantId], references: [id])
  proposedForVersionId String
  stepsJson          Json
  status             String   @default("DRAFT")
  approvalRequired   Boolean  @default(false)
  approvedBy         String?
  approvedAt         DateTime?
  createdAt          DateTime @default(now())
}

model AuditLog {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  actorUserId   String?
  actorUser     User?    @relation(fields: [actorUserId], references: [id])
  action        String
  entityType    String
  entityId      String
  ip            String?
  userAgent     String?
  diffJson      Json?
  correlationId String?
  createdAt     DateTime @default(now())
}

model ApiKey {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  keyHash     String
  scopesJson  Json
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  UNPAID
}

enum BillingInterval {
  MONTH
  YEAR
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  UNCOLLECTIBLE
  VOID
}

model Subscription {
  id                   String             @id @default(uuid())
  tenantId             String             @unique
  tenant               Tenant             @relation(fields: [tenantId], references: [id])
  stripeCustomerId     String             @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  plan                 Plan               @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  billingInterval      BillingInterval    @default(MONTH)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  trialStart           DateTime?
  trialEnd             DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  invoices             Invoice[]
  usageRecords         UsageRecord[]
}

model PaymentMethod {
  id               String   @id @default(uuid())
  tenantId         String
  stripePaymentMethodId String @unique
  type             String   // card, bank_account, etc.
  brand            String?  // visa, mastercard, etc.
  last4            String?
  expiryMonth      Int?
  expiryYear       Int?
  isDefault        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([tenantId])
}

model Invoice {
  id               String        @id @default(uuid())
  subscriptionId   String
  subscription     Subscription  @relation(fields: [subscriptionId], references: [id])
  stripeInvoiceId  String        @unique
  invoiceNumber    String?
  status           InvoiceStatus @default(DRAFT)
  amountDue        Int           // in cents
  amountPaid       Int           @default(0)
  currency         String        @default("usd")
  periodStart      DateTime
  periodEnd        DateTime
  paidAt           DateTime?
  hostedInvoiceUrl String?
  invoicePdf       String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([subscriptionId])
}

model UsageRecord {
  id             String       @id @default(uuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  metricType     String       // datasets, storage, api_calls, users
  quantity       Int
  timestamp      DateTime     @default(now())
  createdAt      DateTime     @default(now())

  @@index([subscriptionId, metricType])
  @@index([timestamp])
}

