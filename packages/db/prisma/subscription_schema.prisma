// Stripe Subscription Models
// Add these to your existing schema.prisma

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
  TRIALING
  INCOMPLETE
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

model Subscription {
  id                   String             @id @default(uuid())
  tenantId             String             @unique
  tenant               Tenant             @relation(fields: [tenantId], references: [id])
  
  // Stripe IDs
  stripeCustomerId     String             @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String
  
  // Subscription details
  plan                 Plan               @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  billingInterval      BillingInterval?
  
  // Billing dates
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  trialEnd             DateTime?
  
  // Metadata
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  
  // Relations
  invoices             Invoice[]
  paymentMethods       PaymentMethod[]
}

model Invoice {
  id                String       @id @default(uuid())
  subscriptionId    String
  subscription      Subscription @relation(fields: [subscriptionId], references: [id])
  
  // Stripe data
  stripeInvoiceId   String       @unique
  stripeInvoiceUrl  String?
  stripePdfUrl      String?
  
  // Invoice details
  amountDue         Int          // in cents
  amountPaid        Int          // in cents
  currency          String       @default("usd")
  status            String       // paid, open, void, uncollectible
  
  // Dates
  periodStart       DateTime
  periodEnd         DateTime
  dueDate           DateTime?
  paidAt            DateTime?
  
  createdAt         DateTime     @default(now())
}

model PaymentMethod {
  id                String       @id @default(uuid())
  subscriptionId    String
  subscription      Subscription @relation(fields: [subscriptionId], references: [id])
  
  // Stripe data
  stripePaymentMethodId String   @unique
  
  // Card details
  type              String       // card, bank_account
  brand             String?      // visa, mastercard, etc
  last4             String?
  expMonth          Int?
  expYear           Int?
  
  // Status
  isDefault         Boolean      @default(false)
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
}

model UsageRecord {
  id           String   @id @default(uuid())
  tenantId     String
  
  // Usage metrics
  datasetsUsed Int      @default(0)
  storageUsed  BigInt   @default(0) // in bytes
  apiCalls     Int      @default(0)
  edaRuns      Int      @default(0)
  
  // Period
  periodStart  DateTime
  periodEnd    DateTime
  
  createdAt    DateTime @default(now())
  
  @@index([tenantId, periodStart])
}

// Update Tenant model to include subscription
// Add this relation to your existing Tenant model:
// subscription Subscription?
